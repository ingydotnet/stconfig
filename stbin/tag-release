#!/bin/sh
set -e


BRANCH=$1
KIND=${2:-"release"}
MSG=${3:-""}

if [ -z "$BRANCH" ]; then
    echo "Usage: $0 branch [prefix [message [version [verbose]]]]"
    exit 1
fi

if [ "$BRANCH" = "-c" ]; then
    BRANCH=`perl -le '$b = readlink("$ENV{ST_SRC_BASE}/current"); $b =~ s(.+/)(); print $b'`
fi
if [ ! -d "$ST_SRC_BASE/$BRANCH" ]; then
    echo "The branch you specified ($BRANCH) must be checked out!";
    exit 1;
fi

VERSION=${4:-$(st-version $BRANCH)}
if [ -z "$VERSION" ]; then
    echo "Error: Could not determine version for $BRANCH";
    exit 1;
fi

TAG=`get-next-release-tag $KIND $VERSION`
if [ -z "$TAG" ]; then
    echo "Error: Could not determine next $KIND tag for $BRANCH";
    exit 1;
fi

VERBOSE=${5:-""}

echo -n "Tag branch $BRANCH as $TAG? [yN] "
read answer
if [ "$answer" != "y" ]; then
    exit
fi

for REPO in `st-repo-list` ; 
do
    MESSAGE="Copying /$REPO/branches/$BRANCH to /$REPO/tags/$TAG $MSG"
    BRANCH_URL="$ST_SVN/$REPO/branches/$BRANCH"
    TAG_URL="$ST_SVN/$REPO/tags/$TAG"
   
    if [ $VERBOSE ]; then
        echo Message: $MESSAGE
        echo From: $BRANCH_URL
        echo To: $TAG_URL
    fi

    if [ "$REPO" = "socialpoint" ]; then
        echo "Using svn to create $TAG";
        if svn -q copy -m "$MESSAGE" $BRANCH_URL $TAG_URL >/dev/null; then
            echo "Created $REPO tag $TAG from branch $BRANCH"
        fi
    else
        REPO_DIR=$ST_SRC_BASE/$BRANCH
        if [ "$REPO" != "socialtext" ]; then
            REPO_DIR="$ST_SRC_BASE/$BRANCH/$REPO"
        fi
        cd $REPO_DIR
        git tag -a $TAG -m "$MESSAGE"
        git push --tags
    fi
done

